name: üìä Automated Grading - Reddit Browser (Task 03)

# Trigger on every push to main/master
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Task 03/submissions/**'  # Only trigger if submissions folder changes
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'Task 03/submissions/**'
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-students: ${{ steps.detect.outputs.students }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Detect changed submissions
        id: detect
        run: |
          SUBMISSIONS_DIR="Task 03/submissions"
          
          if [ ! -d "$SUBMISSIONS_DIR" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "students=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR, compare with base branch
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For push, compare with previous commit
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              # Initial commit - grade all
              CHANGED_FILES=$(find "$SUBMISSIONS_DIR" -name "index.html" -type f)
            else
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} HEAD)
            fi
          fi
          
          # Extract student folders that changed
          STUDENTS=$(echo "$CHANGED_FILES" | grep "Task 03/submissions/" | cut -d'/' -f4 | sort -u)
          
          if [ -z "$STUDENTS" ]; then
            echo "‚ÑπÔ∏è  No submissions changed"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "students=" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Changed students:"
            echo "$STUDENTS" | while read -r student; do
              echo "  - $student"
            done
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "students<<EOF" >> $GITHUB_OUTPUT
            echo "$STUDENTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

  grade-submissions:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üîç Grade changed submissions only
        run: |
          python3 << 'EOF'
          import os
          import json
          import re
          
          SUBMISSIONS_DIR = "Task 03/submissions"
          CHANGED_STUDENTS = """${{ needs.detect-changes.outputs.changed-students }}""".strip().split('\n')
          
          print("üéØ Grading changed submissions only:")
          print(f"Students to grade: {len(CHANGED_STUDENTS)}")
          for student in CHANGED_STUDENTS:
              print(f"  ‚úì {student}")
          print()
          
          def grade_submission(student_folder, index_file):
              """Grade a single submission based on Reddit Browser requirements"""
              with open(index_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              content_lower = content.lower()
              
              scores = {
                  'file_structure': 5,
                  'functionality': 0,
                  'ui_design': 0,
                  'code_quality': 0,
                  'responsive': 0,
                  'issues': []
              }
              
              # ===== FUNCTIONALITY (40 points) =====
              
              # Step 1: Fetch Reddit API (8 pts)
              if 'fetch(' in content_lower and 'reddit.com' in content_lower:
                  scores['functionality'] += 8
              else:
                  scores['issues'].append('‚ùå No Reddit API fetch')
              
              # Step 2: Display posts function (8 pts)
              if re.search(r'function\s+displayposts|displayposts\s*=|const\s+displayposts', content_lower):
                  scores['functionality'] += 8
              else:
                  scores['issues'].append('‚ùå No displayPosts function')
              
              # Step 4: Search/loadPosts function (8 pts)
              if re.search(r'function\s+loadposts|loadposts\s*=|getelementbyid.*input', content_lower):
                  scores['functionality'] += 8
              else:
                  scores['issues'].append('‚ö†Ô∏è No loadPosts/search function')
              
              # Async/await or .then() (6 pts)
              if 'async' in content_lower or '.then(' in content_lower:
                  scores['functionality'] += 6
              else:
                  scores['issues'].append('‚ö†Ô∏è No async handling')
              
              # Error handling (10 pts)
              if 'catch' in content_lower or 'try' in content_lower:
                  scores['functionality'] += 10
              else:
                  scores['issues'].append('‚ùå No error handling')
              
              # ===== UI/DESIGN (30 points) =====
              
              # Step 3: Grid layout (10 pts)
              if 'display: grid' in content_lower or 'display:grid' in content_lower:
                  scores['ui_design'] += 10
              elif 'grid' in content_lower:
                  scores['ui_design'] += 5
              else:
                  scores['issues'].append('‚ùå No CSS grid layout')
              
              # Post cards with images (8 pts)
              if 'post-card' in content_lower or 'postcard' in content_lower:
                  scores['ui_design'] += 4
              if '<img' in content_lower and 'thumbnail' in content_lower:
                  scores['ui_design'] += 4
              else:
                  scores['issues'].append('‚ö†Ô∏è No image/thumbnail handling')
              
              # Stats display: upvotes, comments, author (7 pts)
              stats_count = 0
              if 'ups' in content_lower or 'upvote' in content_lower:
                  stats_count += 1
              if 'num_comments' in content_lower or 'comment' in content_lower:
                  stats_count += 1
              if 'author' in content_lower:
                  stats_count += 1
              scores['ui_design'] += min(stats_count * 2, 7)
              
              # Step 5: Custom styling (5 pts)
              if '<style>' in content_lower and len(re.findall(r'[{]', content)) > 10:
                  scores['ui_design'] += 5
              elif '<style>' in content_lower:
                  scores['ui_design'] += 2
              else:
                  scores['issues'].append('‚ö†Ô∏è Minimal CSS styling')
              
              # ===== CODE QUALITY (15 points) =====
              
              # Multiple functions (5 pts)
              function_count = len(re.findall(r'function\s+\w+|const\s+\w+\s*=\s*(?:async\s*)?\(', content))
              if function_count >= 3:
                  scores['code_quality'] += 5
              elif function_count >= 2:
                  scores['code_quality'] += 3
              
              # DOM manipulation (5 pts)
              if 'getelementbyid' in content_lower or 'queryselector' in content_lower:
                  scores['code_quality'] += 5
              
              # Clean code - no excessive console.log (5 pts)
              console_count = content_lower.count('console.log')
              if console_count <= 2:
                  scores['code_quality'] += 5
              elif console_count <= 5:
                  scores['code_quality'] += 3
              
              # ===== RESPONSIVE DESIGN (10 points) =====
              
              # Media queries (8 pts)
              if '@media' in content_lower:
                  scores['responsive'] += 8
              else:
                  scores['issues'].append('‚ö†Ô∏è No @media queries for mobile')
              
              # Flexbox or grid for responsive (2 pts)
              if 'flex' in content_lower or 'auto-fill' in content_lower or 'auto-fit' in content_lower:
                  scores['responsive'] += 2
              
              # ===== BONUS: Video support (up to 5 extra) =====
              if 'reddit_video' in content_lower or '<video' in content_lower:
                  scores['functionality'] = min(scores['functionality'] + 5, 45)
              
              return scores
          
          # Process ONLY changed submissions
          results = []
          
          for student in CHANGED_STUDENTS:
              if not student.strip():
                  continue
              
              student_path = os.path.join(SUBMISSIONS_DIR, student.strip())
              index_file = os.path.join(student_path, "index.html")
              
              if not os.path.exists(index_file):
                  print(f"‚ö†Ô∏è  {student}: Missing index.html")
                  continue
              
              scores = grade_submission(student, index_file)
              total = sum([
                  scores['file_structure'],
                  scores['functionality'],
                  scores['ui_design'],
                  scores['code_quality'],
                  scores['responsive']
              ])
              
              # Cap at 100
              total = min(total, 100)
              
              # Determine grade
              if total >= 90:
                  grade = 'A'
              elif total >= 80:
                  grade = 'B'
              elif total >= 70:
                  grade = 'C'
              elif total >= 60:
                  grade = 'D'
              else:
                  grade = 'F'
              
              result = {
                  'student': student.strip(),
                  **scores,
                  'total': total,
                  'grade': grade
              }
              results.append(result)
              
              print(f"‚úÖ {student}")
              print(f"   Score: {total}/100 - Grade: {grade}")
              if result['issues']:
                  for issue in result['issues'][:3]:
                      print(f"   {issue}")
          
          # Save results
          with open('grading_results.json', 'w') as f:
              json.dump(results, f, indent=2)
          
          # Print summary
          print("\n" + "="*50)
          print("üìä SUMMARY")
          print("="*50)
          print(f"Submissions graded: {len(results)}")
          if results:
              avg_score = sum(r['total'] for r in results) / len(results)
              print(f"Average score: {avg_score:.1f}/100")
              
              for grade in ['A', 'B', 'C', 'D', 'F']:
                  count = sum(1 for r in results if r['grade'] == grade)
                  if count > 0:
                      print(f"  {grade}: {count}")
          
          EOF

      - name: üìÑ Generate markdown report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime
          
          with open('grading_results.json', 'r') as f:
              results = json.load(f)
          
          current_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          avg_score = round(sum(r['total'] for r in results) / len(results), 1) if results else 0
          
          report = f"""# üìä Reddit Browser - Grading Report (Changed Submissions)

          Generated by GitHub Actions on: {current_date}

          ## Summary

          - **Submissions Graded:** {len(results)}
          - **Average Score:** {avg_score}/100

          ## Individual Results

          """
          
          for result in sorted(results, key=lambda x: x['total'], reverse=True):
              grade_emoji = {'A': 'üéâ', 'B': 'üëç', 'C': 'üëå', 'D': '‚ö†Ô∏è', 'F': '‚ùå'}
              emoji = grade_emoji.get(result['grade'], '‚ùì')
              
              report += f"""
          ### {result['student']} - {emoji} {result['grade']} ({result['total']}/100)

          | Category | Score |
          |----------|-------|
          | File Structure | {result['file_structure']}/5 |
          | Functionality | {result['functionality']}/40 |
          | UI/Design | {result['ui_design']}/30 |
          | Code Quality | {result['code_quality']}/15 |
          | Responsive | {result['responsive']}/10 |
          | **TOTAL** | **{result['total']}/100** |

          """
              
              if result['issues']:
                  report += "**Issues:**\n"
                  for issue in result['issues']:
                      report += f"- {issue}\n"
                  report += "\n"
          
          with open('GRADING_REPORT.md', 'w') as f:
              f.write(report)
          
          print("‚úÖ Report generated: GRADING_REPORT.md")
          EOF

      - name: üì¶ Upload grading results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: grading-results-changed
          path: |
            grading_results.json
            GRADING_REPORT.md

      - name: üí¨ Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('grading_results.json', 'utf8'));
            
            let comment = '# üìä Grading Results (Changed Submissions Only)\n\n';
            comment += `- **Submissions Graded:** ${results.length}\n`;
            
            if (results.length > 0) {
              const avg = (results.reduce((sum, r) => sum + r.total, 0) / results.length).toFixed(1);
              comment += `- **Average Score:** ${avg}/100\n\n`;
              
              comment += '### Results:\n\n';
              results.forEach(r => {
                const emoji = {'A': 'üéâ', 'B': 'üëç', 'C': 'üëå', 'D': '‚ö†Ô∏è', 'F': '‚ùå'}[r.grade] || '‚ùì';
                comment += `- **${r.student}**: ${emoji} ${r.grade} (${r.total}/100)\n`;
              });
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: üìà Create job summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üìä Grading Complete (Changed Submissions)
          
          ‚úÖ Only changed submissions were graded
          üìÑ Report generated
          üì¶ Results available as artifact
          EOF

  no-changes:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ‚ÑπÔ∏è No changes detected
        run: |
          echo "‚ÑπÔ∏è  No submissions were changed in this push"
          echo "Skipping grading workflow"
